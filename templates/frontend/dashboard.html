<script type='text/javascript' src='https://www.google.com/jsapi'></script>
<script type="text/javascript" src="/static/ydn.db-jquery-0.2.4.js"></script>
<script type="text/javascript">
    
    function drawCharts(){
        // Init stats db
        var schema = {
            stores:[{
                name:'stats',
                keyPath:'timeStamp',
                type: 'TEXT',
                indexes: [
                {
                    keyPath: 'statname',
                    type: 'TEXT'
                }
            ]
        }]
        };
        var db = new ydn.db.Storage('STATSDB');
        
        // Gauge cachehitrate
        var hitrate_data = google.visualization.arrayToDataTable([
            ['Label', 'Value'],
            ['HitRate %', {{ cache_stats.Hitrate }}]
        ]);

        var hitrate_options = {
            width: 200, height: 120,
            redFrom: 0, redTo: 20,
            yellowFrom:20, yellowTo: 40,
            greenFrom:80, greenTo: 100,
            minorTicks: 5
            }
        
        var hitrate_chart = new google.visualization.Gauge(document.getElementById('hitrate_div'));
        hitrate_chart.draw(hitrate_data, hitrate_options);
        setInterval(function() {
            $.get("/api/cache_stats/", function(data) {
                hitrate_data.setValue(0,1, data.Hitrate);
                hitrate_chart.draw(hitrate_data, hitrate_options);
            }, "json");
            }, 5000);


        var memory_data = google.visualization.arrayToDataTable([
            ['Label', 'Value'],
            ['Memory Usage', {{ memory_stats.MBytes_allocated }}]
        ]);

        memory_chart = new google.visualization.Gauge(document.getElementById('memory_div')).draw(memory_data,
            {
            width: 400, height: 120,
            // redFrom: 220 , redTo: 250,
            // yellowFrom:70, yellowTo: 90,
            // greenFrom:00, greenTo: 30,
            minorTicks: 5,
            max: {{ memory_stats.MBytes_available }}
            }
            );

        // Barchart hits-misses
        var hitmiss_options = {
            title:"Hits - Misses",
            width:600, height:200,
            legend: 'none',
            colors: ['green'],
        }
        var hitmiss_data = google.visualization.arrayToDataTable([
            ['Label', 'Value'],
            ['Cache Hits', {{ cache_stats.Cache_Hits }}],
            ['Cache Misses', {{ cache_stats.Cache_Misses }}]
        ]);
        var hitmiss_chart = new google.visualization.ColumnChart(document.getElementById('hitrequest_div'));
        hitmiss_chart.draw(hitmiss_data, hitmiss_options);

        setInterval(function() {
            $.get("/api/cache_stats/", function(data) {
                hitmiss_data.setValue(0, 1, parseInt(data.Cache_Hits));
                hitmiss_data.setValue(1, 1, parseInt(data.Cache_Misses));
                hitmiss_chart.draw(hitmiss_data, hitmiss_options);
                var now = new Date();
                recordhist = {
                    date: now,
                    statname: 'cache_hits',
                    value: data.Cache_Hits
                };
                recordmiss = {
                    date: now,
                    statname: 'cache_miss',
                    value: data.Cache_Misses
                };

                req = db.put('STATSDB', [ recordhist, recordmiss ] );
                // db.put({name: 'STATSDB', keyPath: 'date'}, recordhist);
                
                // db.put({name: 'STATSDB', keyPath: 'date'}, recordmiss);
                // records = [
                //     { date: now, statname: 'cache_hits', value: data.Cache_Hits },
                //     { date: now, statname: 'cache_miss', value: data.Cache_Misses },
                // ];
                // req = db.put({name: 'STATSDB', keyPath: 'date'}, records);
                // db.put( [{name: 'STATSDB', keyPath: 'date' }, recordhist , {name: 'STATSDB', keyPath: 'date' }, recordmiss ] );
                // req = db.put( 'STATSDB', [ recordhist, recordmiss ] );
                req.done(function(key) {
                    console.log(key);
                });
                req.fail(function(e) {
                    throw e;
                });
                // db.put('STATSDB', [ { date: now, statname: 'cache_hits', value: data.Cache_Hits }, { date: now, statname: 'cache_miss', value: data.Cache_Misses } ])
            }, "json");
        }, 5000);

        // Barchart client request
        var request_options = {
            title:"Client Requests",
            width:600, height:200,
            legend: 'none'
        }
        var request_data = google.visualization.arrayToDataTable([
            ['Label', 'Value'],
            ['Client Requests', {{ cache_stats.Client_Requests }}]
        ]);
        var request_chart = new google.visualization.ColumnChart(document.getElementById('req_div'));
        request_chart.draw(request_data, request_options);

        setInterval(function() {
            $.get("/api/cache_stats/", function(data) {
                request_data.setValue(0, 1, parseInt(data.Client_Requests));
                request_chart.draw(request_data, request_options);
                var now = new Date();
                // recordclireq = { date: now, statname: 'client_requests', value: data.Client_Requests };
                // db.put({name: 'STATSDB', keyPath: 'date'}, recordclireq);
            }, "json");
        }, 5000);

        // Line chart Client requests with websql history
        var statsarray = new Array();
        db.transaction(function (tx) {
            tx.executeSql('SELECT date, value FROM stats where statname="client_requests"', [], 
                function (tx, results) {
                    var len = results.rows.length, i;
                    
                    for (i = 0; i < len; i++){
                        statsarray[i] = {statname: results.rows.item(i)[0], value: results.rows.item(i)[1]};
                    }
                }, null);
        });
        var data = google.visualization.arrayToDataTable([
            statsarray
        ]);
        var reqline_chart =new google.visualization.LineChart(document.getElementById('reqline_div'));
        reqline_chart.draw(data, {
            curveType: "function",
            width: 500, height: 400,
            vAxis: {maxValue: 10}
            }
        );
    }
    
    google.setOnLoadCallback(drawCharts);
    google.load("visualization", "1", {packages:["corechart","gauge",]});

    
</script>

<div id="dashboard">
    <div id="hitrate_div" style="left: 20%; width: 140px; position: fixed;"></div>
    <div id="memory_div" style="left: 20%; width: 140px; position: relative;"></div>
    <div id="hitrequest_div"></div>
    <div id="req_div"></div>
    <div id="reqline_div"></div>"
</div>